input {
  pipeline {
    address => "fhir-patient"
  }
}

filter {
  if [resource][meta][tag][0][display] == "Golden Record" {
    drop { }
  }

  # add fingerprint of patient golden ID
  mutate {
    copy => { "[resource][link][0][other][reference]" => "[@metadata][golden_id_fingerprint]" }
  }
  mutate {
    gsub => [ "[@metadata][golden_id_fingerprint]", "Patient/", "" ]
  }
  fingerprint {
    source => "[@metadata][golden_id_fingerprint]"
    target => "[patient][golden_id_fingerprint]"
  }

  mutate {
    add_field => {
      "[patient][fhirID]" => "%{[resource][id]}"
      "[patient][gender]" => "%{[resource][gender]}"
      "[patient][birthDate]" => "%{[resource][birthDate]}"
    }
  }

  mutate {
    add_field => {
      "[@metadata][id]" => "report-patient-%{[patient][fhirID]}"
    }
  }

  prune {
    whitelist_names => [ "patient", "@timestamp" ]
  }
}

output {
  elasticsearch {
    hosts => [ "es-analytics:9200" ]
    index => "fhir-report-patient"
    document_id => "%{[@metadata][id]}"
    action => "update"
    doc_as_upsert => true
    user => "elastic"
    password => "dev_password_only"
  }
}
