input {
  http {
    port => 5055
    additional_codecs => {
      "application/fhir+json" => "json"
    }
  }
}

filter {
  if ![entry] or ![entry][0] {
    drop { }
  }

  split {
    field => "entry"
  }

  mutate {
    rename => ["[entry][resource]", "resource"]
  }

  mutate {
    rename => ["[entry][request][method]", "method"]
  }

  mutate {
    remove_field => ["entry", "resourceType", "total", "link", "headers", "meta", "id", "type", "@version", "host"]
  }

  mutate {
    add_field => { "[@metadata][lc_resourceType]" => "%{[resource][resourceType]}" }
  }

  mutate {
    lowercase => [ "[@metadata][lc_resourceType]" ]
  }
}

output {
  elasticsearch {
    hosts => [ "es:9200" ]
    index => "fhir-%{[@metadata][lc_resourceType]}"
  }

  stdout {
    codec => rubydebug
  }
}
